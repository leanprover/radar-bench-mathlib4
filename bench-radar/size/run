#!/usr/bin/env python3

import json
import re
from pathlib import Path


def print_result(metric: str, value: float, unit: str | None = None) -> None:
    data = {"metric": metric, "value": value}
    if unit is not None:
        data["unit"] = unit
    print(f"radar::measurement={json.dumps(data)}")


def measure_leans() -> None:
    lean_files = 0
    lean_lines = 0
    porting_notes = 0
    for path in Path().glob("Mathlib/**/*.lean"):
        lean_files += 1
        with open(path) as f:
            for line in f:
                lean_lines += 1
                if re.match("porting notes", line, re.IGNORECASE):
                    porting_notes += 1
    print_result("size/.lean//files", lean_files)
    print_result("size/.lean//lines", lean_lines)
    print_result("size/.lean//porting-notes", porting_notes)


def measure_oleans() -> None:
    olean_files = 0
    olean_bytes = 0
    for path in Path().glob(".lake/build/**/*.olean"):
        olean_files += 1
        olean_bytes += path.stat().st_size
    print_result("size/.olean//files", olean_files)
    print_result("size/.olean//lines", olean_bytes, "b")


if __name__ == "__main__":
    measure_leans()
    measure_oleans()
