#!/usr/bin/env bash
set -eo pipefail

# Prepare build
# Use build cache for proofwidgets, but not for anything else.
lake clean
LEAN_PATH=$(lean --print-libdir) lake build proofwidgets
rm -f .lake/packages/batteries/.lake/build/bin/runLinter

# Run build
LAKE_OVERRIDE_LEAN=true LEAN=$(realpath scripts/bench-radar/build/fake-root/bin/lean) \
  scripts/bench-radar/measure.py -t build \
  -m instructions -m maxrss -m task-clock -m wall-clock -- \
  lakeprof record lake build --no-cache

# Analyze lakeprof data
lakeprof report -pj | jq -r '"radar::measurement=\({metric: "build/lakeprof/longest build path//wall-clock", value: .[-1][2], unit: "s"})"'
lakeprof report -rj | jq -r '"radar::measurement=\({metric: "build/lakeprof/longest rebuild path//wall-clock", value: .[-1][2], unit: "s"})"'
