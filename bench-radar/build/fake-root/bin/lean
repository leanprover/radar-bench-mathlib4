#!/usr/bin/env python

import argparse
import json
import re
import subprocess
import sys
from pathlib import Path


def print_result(metric: str, value: float, unit: str | None = None) -> None:
    data = {"metric": metric, "value": value}
    if unit is not None:
        data["unit"] = unit
    print(f"radar::measurement={json.dumps(data)}")


def run(*command: str) -> None:
    subprocess.run(command, check=True)


def run_stderr(*command: str) -> str:
    result = subprocess.run(command, check=True, capture_output=True, encoding="utf-8")

    # Reduce log size
    for line in result.stdout.splitlines():
        if "radar::measurement=" in line:
            print(line)
    for line in result.stderr.splitlines():
        if "radar::measurement=" in line:
            print(line, file=sys.stderr)

    return result.stderr


def get_module(setup: Path) -> str:
    with open(setup) as f:
        return json.load(f)["name"]


def count_lines(module: str, path: Path) -> None:
    with open(path) as f:
        lines = sum(1 for _ in f)
    print_result(f"build/module/{module}//lines", lines)


def run_lean(module: str) -> None:
    stderr = run_stderr(
        "scripts/bench-radar/measure.py",
        *("-t", f"build/module/{module}"),
        *("-m", "instructions"),
        "--",
        *("lean", "--profile", "-Dprofiler.threshold=10000"),
        *sys.argv[1:],
    )

    for line in stderr.splitlines():
        # Output of `lean --profile`
        # See timeit.cpp for the time format
        if match := re.fullmatch(r"\t(.*) ([\d.]+)(m?s)", line):
            name = match.group(1)
            seconds = float(match.group(2))
            if match.group(3) == "ms":
                seconds = seconds / 1000
            print_result(f"build/profile/{name}//wall-clock", seconds, "s")


def main() -> None:
    if sys.argv[1:] == ["--print-prefix"]:
        print(Path(__file__).resolve().parent.parent)
        return

    if sys.argv[1:] == ["--githash"]:
        run("lean", "--githash")
        return

    parser = argparse.ArgumentParser()
    parser.add_argument("lean", type=Path)
    parser.add_argument("--setup", type=Path)
    args, _ = parser.parse_known_args()

    lean: Path = args.lean
    setup: Path = args.setup

    module = get_module(setup)
    count_lines(module, lean)
    run_lean(module)


if __name__ == "__main__":
    main()
